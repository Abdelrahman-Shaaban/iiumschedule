from google.appengine.ext import webapp
from google.appengine.ext.webapp import util
import os
from google.appengine.ext.webapp import template
from google.appengine.ext import db
import re
import urllib2
import json
from scheduleformatter import SavedSchedule

FB_APP_ID='207943475977546'
FB_CLIENT_SECRET='31ed0d30f91d2a64ab3c0620370b52f6'

class FbscheduleSchedule(db.Model):
    fb=db.StringProperty()
    data=db.TextProperty()
    
fbidregex=re.compile(r'^/onfacebook/(.*?)/?$')
def get_fbid_from_path(path):
    match=fbidregex.search(path)
    if(match):
      return match.group(1)
    return None
    
class MainHandler(webapp.RequestHandler):
      def get(self):
	    fbid=get_fbid_from_path(self.request.path)
	    if(fbid==None):
	        path = os.path.join(os.path.dirname(__file__), 'missingfacebook.html')
	        self.response.out.write(template.render(path,{}))
	        return
	    schedule=FbscheduleSchedule.get_by_key_name(fbid)
	    path = os.path.join(os.path.dirname(__file__), 'facebookschedule.html')
	    self.response.out.write(template.render(path,{"data":schedule.data}))
	    return
	    
class FacebookRegister(webapp.RequestHandler):
      def get(self):
	    state=self.request.get("state")
	    if(self.request.get("error",None)):
	        path = os.path.join(os.path.dirname(__file__), 'errorfacebookauth.html')
	        self.response.out.write(template.render(path,{"token":state,"message":request.response.out.get("error_description")}))
	        return
	    code=self.request.get("code")
	    requesturl="https://graph.facebook.com/oauth/access_token?client_id="+FB_APP_ID+\
			"&redirect_uri=https%3A%2F%2Fiiumschedule.appspot.com%2Fonfacebook%2Freg%2F"+\
			"&client_secret="+FB_CLIENT_SECRET+\
			"&code="+code
	    response=urllib2.urlopen(requesturl)
	    response=response.read()
	    if(re.search(r'^{.*}$',response)):
		obj=json.loads(response)
	        path = os.path.join(os.path.dirname(__file__), 'errorfacebookauth.html')
	        self.response.out.write(template.render(path,{"token":state,"message":obj["error"]["message"]}))
	        return
	    match=re.search(r'^access_token=([^&]*)&',response)
	    if(match):
		token=match.group(1)
		#get the schedule, put them in a new fbrecord, redirect to it.
		
		
		
		
	    
	    
	    
application = webapp.WSGIApplication([	('/onfacebook/get/?',FacebookRegister),
					('/onfacebook/', MainHandler),
				      ],
				      debug=True)