/*! iiumschedule 2014-06-30 */
angular.module("smaker",["ngAnimate","pasvaz.bindonce"]).service("smglobal",["$rootScope","$q","$http",function($rootScope,$q,$http){var gobj={mode:"startpage",schedule:{},coursearray:[],session:"",student_type:"",semester:"",sectioncache:{},cur_hover_section:void 0,loading_section_query:!1};return gobj.add_section=function(section){var c=gobj.has_collide(section);if(c)return void alert("This section collide with "+c.code+" section "+c.section);var obj=section;gobj.section_added(section.section_id)||(gobj.subject_added(section.code)?alert("Another section has been selected for this subject. Please remove that first"):gobj.schedule[obj.code]=obj)},gobj.subject_added=function(code){return gobj.schedule[code]},gobj.section_added=function(section_id){return _.find(gobj.schedule,function(o){return o.section_id==section_id})},gobj.remove_section=function(section_id){var section=gobj.section_added(section_id);delete gobj.schedule[section.code]},gobj.replace_section=function(section,subject){var asection=gobj.subject_added(subject.code);gobj.remove_section(asection.section_id),gobj.add_section(section,subject)},gobj.check_collide=function(section1,section2){return void 0!==_.find(section1.schedule,function(s1){return void 0!==_.find(section2.schedule,function(s2){return s1.day==s2.day&&(s1.end<=s2.end&&s1.end>s2.start||s1.start>=s2.start&&s1.start<s2.end)?!0:!1})})},gobj.has_collide=function(section){return _.find(gobj.schedule,function(c){return c.section_id!=section.section_id&&gobj.check_collide(c,section)?!0:!1})},gobj.section_preprocess=function(section,subject){function make_long(d){if("M"==d)return"MON";if("T"==d)return"TUE";if("W"==d)return"WED";if("TH"==d)return"THUR";if("F"==d)return"FRI";if("SN"==d)return"SUN";if("S"==d)return"SAT";throw"Unknown day ->"+d}var obj={section_id:section.id,code:subject.code,credithour:subject.ch,section:section.sectionno,title:subject.title,lecturer:section.lecturer,venue:section.venue,time:section.time,day:section.day,schedule:[]},small=section.venue.split(" ");obj.smallvenue=small[0];var rtimes=/^([0-9\.]+)\s*-\s*([0-9\.]+)\s*(AM|PM)$/.exec(section.time),starttime=1,endtime=2;if(!rtimes||4!=rtimes.length)return console.log(" -  "==section.time?"WARNING:Unfortunately this section's schedule is not available yet. Please select another section,":"WARNING:Error: unable to identify the format for the time "+section.time+". Please be patient while we try to fix this issue"),obj;starttime=parseFloat(rtimes[1],10);var parseendtime=/^\D*([0-9\.]+)\D*$/.exec(rtimes[2]);parseendtime?endtime=parseFloat(parseendtime[1],10):(console.log("Missing end time. Lets just say it use 1 hour."),endtime=starttime+1),"PM"==rtimes[3]&&12>starttime&&12>endtime&&(starttime+=12,endtime+=12),obj.starttime=starttime,obj.endtime=endtime;var rawday=section.day,days=[];if(/\s*(MON|TUE|WED|THUR|FRI|SAT|SUN)\s*/.exec(rawday))days.push(rawday);else if(/\s*(MON|TUE|WED|THUR|FRI|SAT|SUN)-(MON|TUE|WED|THUR|FRI|SAT|SUN)\s*/.exec(rawday)){var execed=/\s*(MON|TUE|WED|THUR|FRI|SAT|SUN)-(MON|TUE|WED|THUR|FRI|SAT|SUN)\s*/.exec(rawday);days.push(execed[1]),days.push(execed[2])}else if(/\s*(M|TH|W|T|F|SN|S)\s*-\s*(M|TH|W|T|F|SN|S)\s*-\s*(M|TH|W|T|F|SN|S)\s*/.exec(rawday)){var execed=/\s*(M|TH|W|T|F|SN|S)\s*-\s*(M|TH|W|T|F|SN|S)\s*-\s*(M|TH|W|T|F|SN|S)\s*/.exec(rawday);days.push(make_long(execed[1])),days.push(make_long(execed[2])),days.push(make_long(execed[3]))}else if(/\s*(M|TH|W|T|F|SN|S)\s*-\s*(M|TH|W|T|F|SN|S)\s*/.exec(rawday)){var execed=/\s*(M|TH|W|T|F|SN|S)\s*-\s*(M|TH|W|T|F|SN|S)\s*/.exec(rawday);days.push(make_long(execed[1])),days.push(make_long(execed[2]))}else if("TWF"==rawday)days.push("TUE"),days.push("WED"),days.push("FRI");else{if(-1=="MTWTHF".indexOf(rawday))return console.log("Unknown day format ->"+rawday+" please be patient as we resolve this issue."),obj;var idx="MTWTHF".indexOf(rawday),length=rawday.length;-1!=rawday.indexOf("TH")&&length--,"F"==rawday&&(idx-=1);for(var dayidx=["MON","TUE","WED","THUR","FRI"],i2=idx;idx+length>i2;)days.push(dayidx[i2]),i2++}return _.each(days,function(day){var newschedule={day:day,start:starttime,end:endtime,venue:obj.venue};obj.schedule.push(newschedule)}),obj},gobj.fetch_section=function(sub){function successc(obj){var list=obj.data;gobj.sectioncache[sub.id]=obj;for(var alist=[],i=0;i<list.length;i++){var hasa=gobj.section_preprocess(list[i],sub);hasa?alist.push(hasa):console.log("Warning, unable to preprocess section "+list[i].sectionno)}return list=alist}var deferred=$q.defer();return void 0!==gobj.sectioncache[sub.id]?(setTimeout(function(){$rootScope.$apply(function(){deferred.resolve(successc(gobj.sectioncache[sub.id]))})}),deferred.promise):$http({url:"/schedulemaker/fetch_section/",params:{id:sub.id},method:"GET"}).then(successc)},gobj}]).controller("schedulemaker",["smglobal","$scope","$http",function(smglobal,$scope){function resyncschedule(){if($scope.schedule=_.values(smglobal.schedule),void 0!==smglobal.cur_hover_section){var obj=$.extend({},smglobal.cur_hover_section);obj.hover=!0,$scope.schedule.push(obj)}}$scope.smglobal=smglobal,$scope.alert=function(t){console.log("This is alert "+t)},$scope.generateLink=function(){return location.origin+"/schedulemaker/?"+$.param({ses:smglobal.session,sem:smglobal.semester,st:smglobal.student_type,code:_.pluck(smglobal.schedule,"code").join(","),section:_.pluck(smglobal.schedule,"section").join(",")})},$scope.$watchCollection("smglobal.schedule",resyncschedule),$scope.$watch("smglobal.cur_hover_section",resyncschedule)}]).controller("startform",["$scope","$http","smglobal","$timeout","$q","$rootScope",function($scope,$http,smglobal,$timeout,$q){$scope.available_sessions=["2013/2014","2014/2015"],$scope.available_student_type={ug:"undergraduate",pg:"postgraduate"},$scope.session="2014/2015",$scope.student_type="ug",$scope.semester=1,$scope.start_form_submit=function(){if($scope.start_form.session.$valid&&void 0!==$scope.start_form.session&&$scope.start_form.semester.$valid&&void 0!==$scope.start_form.session&&$scope.start_form.student_type.$valid&&void 0!==$scope.start_form.session){$scope.show_submit_error=!1,smglobal.mode="startloading",_.extend(smglobal,_.pick($scope,"session","semester","student_type"));var params={session:$scope.session,semester:$scope.semester,coursetype:$scope.student_type};$http({url:"/schedulemaker/fetch_subject/",params:params,method:"GET"}).success(function(coursearray){if(smglobal.mode="picker",_.each(coursearray,function(v,kuly){_.each(v,function(sub){sub.kuly=kuly})}),smglobal.coursearray=coursearray,$(window).resize(),window.schedulequery){for(var codes=window.schedulequery.code.split(","),sections=window.schedulequery.section.split(","),promises=[],i=0;i<codes.length;){var subject,code=codes[i],csection=sections[i];_.find(coursearray,function(v){return _.find(v,function(sub){return sub.code==code?(subject=sub,!0):void 0})}),void 0!==subject?(!function(csection,subject){var promise=smglobal.fetch_section(subject).then(function(fetchedsections){_.find(fetchedsections,function(section){section.section==csection&&smglobal.add_section(section)})});promises.push(promise)}(csection,subject),i++):(console.log("WARNING:Subject "+code+" not found"),i++)}$q.all(promises).then(function(){smglobal.loading_section_query=!1})}}).error(function(){smglobal.mode="startpage",smglobal.loading_section_query=!0,alert("Sorry, an error happened when fetching subjects. The server may be down")})}else $scope.show_submit_error=!0,console.log("Submit called start form "+JSON.stringify($scope.start_form.$valid))},window.schedulequery&&($scope.session=window.schedulequery.ses,$scope.semester=window.schedulequery.sem,$scope.student_type=window.schedulequery.st,$timeout(function(){$scope.start_form_submit()},10))}]).controller("sectionSelector",["$scope","smglobal","$filter",function($scope,smglobal,$filter){function refilter(){$scope.filteredSubject=""!==$scope.selected_kuly?$filter("filter")($scope.asubject,{kuly:$scope.selected_kuly}):$scope.asubject,$scope.filteredSubject=$filter("filter")($scope.filteredSubject,$scope.subsearch),$scope.filteredSubject.length>scrollthreshold?($scope.filteredSubject=_.first($scope.filteredSubject,scrollthreshold),$scope.scroll_limit_reached=!0):$scope.scroll_limit_reached=!1}_.extend($scope,{selected_kuly:"",asubject:[],smglobal:smglobal,mode:"subject",loading_section:!1,scroll_limit_reached:!1,selected_subject:{}});var scrollthreshold=300;$scope.$watch("selected_kuly",refilter),$scope.$watch("subsearch",refilter),$scope.$watch("asubject",refilter),$scope.toggle_selected=function(k){$scope.selected_kuly=$scope.selected_kuly==k?"":k},$scope.show_section=function(sub){$scope.selected_subject=sub,$scope.loading_section=!0,$scope.mode="section",smglobal.fetch_section(sub).then(function(obj){$scope.csections=obj,$scope.loading_section=!1},function(){alert("Sorry, failed to load section."),$scope.mode="subject",$scope.loading_section=!1})},$scope.$watchCollection(function(){return smglobal.coursearray},function(){$scope.asubject=[],_.each(smglobal.coursearray,function(arr){_.each(arr,function(obj){$scope.asubject.push(obj)})})})}]).directive("formattedSchedule",function(){return{scope:{template:"=?",schedule:"="},link:function(scope,element){function redraw(){var schedule=scope.schedule;void 0===schedule&&(schedule=[]);var cdata=convert_data({coursearray:schedule});$(element).html(new EJS({text:$(scope.template).html()}).render(cdata))}function convert_data(data){function makearray(length){for(var thearray=[],i=0;length>i;)thearray.push(""),i+=1;return thearray}for(var coursearray=data.coursearray,actualstarthour=8,actualendhour=20,startfminute=12*actualstarthour,actualhournum=actualendhour-actualstarthour,fiveminutenum=12*actualhournum,byfiveminute={MON:makearray(fiveminutenum),TUE:makearray(fiveminutenum),WED:makearray(fiveminutenum),THUR:makearray(fiveminutenum),FRI:makearray(fiveminutenum),SAT:makearray(fiveminutenum),SUN:makearray(fiveminutenum)},ci=0;ci<coursearray.length;){for(var course=coursearray[ci],si=0;si<course.schedule.length;){var schedule=course.schedule[si],start=schedule.start,end=schedule.end,starth=Math.floor(start),startm=start-starth;startm=Math.round(100*startm/5),startm+=12*starth;var endh=Math.floor(end),endm=end-endh;endm=Math.round(100*endm/5),endm+=12*endh;var durationm=endm-startm;for(byfiveminute[schedule.day][startm-startfminute]={course:course,duration:durationm,venue:course.schedule[si].venue},i=1;durationm>i;)byfiveminute[schedule.day][startm-startfminute+i]="none",i+=1;si+=1}ci+=1}var thedata={byfiveminute:byfiveminute,actualstarthour:actualstarthour,actualendhour:actualendhour,courselist:coursearray};return thedata}(void 0===scope.template||""===scope.template)&&(scope.template="#schedtemplate"),scope.$watch("schedule",redraw)}}}).directive("niceScroll",function(){return{link:function(scope,el){$(el).niceScroll()}}}).controller("generator",["smglobal","$scope","$filter","$q",function(smglobal,$scope,$filter,$q){function refilter(){$scope.filteredSubject=""!==$scope.selected_kuly?$filter("filter")($scope.asubject,{kuly:$scope.selected_kuly}):$scope.asubject,$scope.filteredSubject=$filter("filter")($scope.filteredSubject,$scope.subsearch)}_.extend($scope,{selected_kuly:"",asubject:[],smglobal:smglobal,mode:"subject",selectedSubjects:[],result_threshold:50,actual_length:0}),_.each(smglobal.schedule,function(sect){sect.code;_.find(smglobal.coursearray,function(list){return _.find(list,function(sub){return sub.code==sect.code?($scope.selectedSubjects.push(sub),!0):void 0})})}),$scope.$watch("selected_kuly",refilter),$scope.$watch("subsearch",refilter),$scope.$watch("asubject",refilter),$scope.sectioncount={},$scope.fetching_sections=!1;var curop=0,fetch_sections=function(){$scope.fetching_sections=!0,curop++;var icurop=curop,coursearray={},promises=[];_.each($scope.selectedSubjects,function(sub){var defer=smglobal.fetch_section(sub);defer.then(function(list){list.length&&(coursearray[sub.code]=list,$scope.sectioncount[sub.code]=list.length)}),promises.push(defer)}),$q.all(promises).then(function(){function has_collide(arr,it){return 0===arr.length?!1:_.find(arr,function(c){return smglobal.check_collide(c,it)})}function recurit(temp,depth){_.each(values[depth],function(cur){if(!has_collide(temp,cur)){if(temp.push(cur),depth<values.length-1)recurit(temp,depth+1);else if(depth==values.length-1){var nc=temp.slice(0);results.push(nc)}temp.splice("-1",1)}})}if(icurop==curop){$scope.fetching_sections=!1;var values=_.values(coursearray),temp=[],results=[];recurit(temp,0),$scope.actual_length=results.length,$scope.results=results.length>$scope.result_threshold?_.first(results,$scope.result_threshold):results}},function(){console.log("Error, fail to fetch all section ")})};$scope.$watchCollection("selectedSubjects",fetch_sections),$scope.$watchCollection("result_threshold",fetch_sections),fetch_sections(),$scope.toggle_selected=function(k){$scope.selected_kuly=$scope.selected_kuly==k?"":k},$scope.$watchCollection(function(){return smglobal.coursearray},function(){$scope.asubject=[],_.each(smglobal.coursearray,function(arr){_.each(arr,function(obj){$scope.asubject.push(obj)})})}),$scope.subjectAdded=function(s){var ret=_.find($scope.selectedSubjects,function(i){return i==s});return ret},$scope.addSubject=function(s){$scope.subjectAdded(s)||$scope.selectedSubjects.push(s)},$scope.removeSubject=function(s){$scope.selectedSubjects=_.without($scope.selectedSubjects,s)},$scope.toggleSubject=function(s){$scope.subjectAdded(s)?$scope.removeSubject(s):$scope.addSubject(s)},$scope.useResult=function(r){var newschedule={};_.each(r,function(ri){newschedule[ri.code]=ri}),smglobal.schedule=newschedule,smglobal.mode="picker"}}]).controller("formatterform",["$scope","smglobal","$http",function($scope,smglobal){$scope.smglobal=smglobal,$scope._=window._,$scope.JSON=window.JSON,$scope.$watchCollection("smglobal.schedule",function(){var schedule=_.map(smglobal.schedule,function(scheditem){return _.pick(scheditem,"code","credithour","schedule","section","title")});$scope.schedule=schedule}),$scope.token="",$scope.requested=!1,$scope.requesting=!1,$scope.save=function(){var data={scheduletype:"MAINCAMPUS",ic:"",matricnumber:"",program:"",semester:"",session:"",studentname:""};_.extend(data,_.pick(smglobal,"ic","matricnumber","program","semester","session","studentname")),data.coursearray=$scope.schedule,$scope.requesting=!0,$scope.requested=!1,$.ajax({url:"/scheduleformatter/",type:"POST",data:{data:JSON.stringify(data)},success:function(token){$scope.$apply(function(){$scope.token=token,$scope.requested=!0,$scope.requesting=!1})},error:function(err){$scope.$apply(function(){$scope.requesting=!1,alert("Sorry, an error occur while saving schedule."),console.log("Error saving "+err)})}})}}]);